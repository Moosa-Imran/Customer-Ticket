<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ticket Detials</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
</head>
<link href="https://cdn.jsdelivr.net/npm/flowbite@2.5.1/dist/flowbite.min.css" rel="stylesheet" />
<script src="https://cdn.tailwindcss.com"></script>

</head>

<body>
    <div id="loader">
        <span class="loader"></span>
    </div>

    <div class="antialiased bg-gray-50 dark:bg-gray-900">

        <!-- Navbar -->
        <%- include('components/navbar') %>
            <!-- Sidebar -->
            <%- include('components/sidebar') %>

                <main class="main p-4 md:ml-64 h-screen min-h-screen pt-20 bg-gray-50 dark:bg-gray-900">
                    <div class="ticket-details bg-white dark:bg-gray-800 rounded-lg shadow-md p-6">
                        <h1 class="text-4xl font-bold text-black dark:text-white">Ticket Details</h1>

                        <div class="ticket-chat flex flex-col md:flex-row mt-6 space-y-4 md:space-y-0">
                            <!-- Ticket Information (Left Side) -->
                            <div
                                class="ticket-info w-full md:w-1/3 pr-6 border-b md:border-r border-gray-300 dark:border-gray-700 md:border-b-0">
                                <h2 class="text-2xl font-semibold text-black dark:text-white mb-4">Ticket Information
                                </h2>
                                <div class="ticket-info-list text-sm space-y-2">
                                    <p class="dark:text-white"><strong>Ticket Number:</strong>
                                        <%= ticket.ticketNo %>
                                    </p>
                                    <p class="dark:text-white"><strong>Full Name:</strong>
                                        <%= ticket.fullName %>
                                    </p>
                                    <p class="dark:text-white"><strong>Email:</strong>
                                        <%= ticket.email %>
                                    </p>
                                    <p class="dark:text-white"><strong>Phone Number:</strong>
                                        <%= ticket.phoneNumber %>
                                    </p>
                                    <p class="dark:text-white"><strong>Address:</strong>
                                        <%= ticket.address %>
                                    </p>
                                    <p class="dark:text-white"><strong>Occupation:</strong>
                                        <%= ticket.occupation %>
                                    </p>
                                    <p class="dark:text-white"><strong>Matrial Status:</strong>
                                        <%= ticket.matrialStatus %>
                                    </p>
                                    <p class="dark:text-white"><strong>Service Type:</strong>
                                        <%= ticket.serviceType %>
                                    </p>
                                    <p class="dark:text-white"><strong>Sub-Service:</strong>
                                        <%= ticket.subService %>
                                    </p>
                                    <p class="dark:text-white"><strong>Status:</strong> <span
                                            class="<%= ticket.status === 'resolved' ? 'text-yellow-500' : 'text-green-500' %>">
                                            <%= ticket.status %>
                                        </span></p>
                                    <p class="dark:text-white"><strong>Created At:</strong>
                                        <%= ticket.createdAt.toLocaleString() %>
                                    </p>
                                </div>
                            </div>

                            <!-- Chat Box (Right Side) -->
                            <div class="chat-box w-full md:w-2/3 pl-6">
                                <h2 class="text-2xl font-semibold text-black dark:text-white mb-4">Customer Chat</h2>

                                <div class="messages space-y-4 h-96 overflow-y-auto">
                                    <% ticket.conversation.forEach(function (message) { %>
                                        <div
                                            class="message <%= message.sender === 'customer' ? 'bg-blue-500 text-white' : 'bg-gray-300' %> p-4 rounded-lg max-w-md <%= message.sender === 'customer' ? 'ml-auto' : '' %>">
                                
                                            <p><strong>
                                                <%= message.sender === 'customer' ? ticket.fullName : 'Agent' %>:
                                            </strong></p>
                                
                                            <% if (message.message.startsWith('$$file:=>')) { %>
                                                <% const fileName = message.message.replace('$$file:=>', ''); %>
                                                <% if (fileName.endsWith('.pdf')) { %>
                                                    <!-- Render PDF -->
                                                    <a href="/uploads/<%= fileName %>" target="_blank" class="text-blue-200 underline flex items-center space-x-2">
                                                        <i class="fas fa-file-pdf text-red-500"></i>
                                                        <span>View PDF</span>
                                                    </a>
                                                <% } else { %>
                                                    <!-- Render image -->
                                                    <a href="/uploads/<%= fileName %>" target="_blank">
                                                        <img src="/uploads/<%= fileName %>" 
                                                             alt="Uploaded File" 
                                                             class="mt-2 w-40 h-auto rounded-md shadow-md">
                                                    </a>
                                                <% } %>
                                            <% } else { %>
                                                <!-- Render text message -->
                                                <p>
                                                    <%= message.message %>
                                                </p>
                                            <% } %>
                                
                                            <p class="text-xs text-white-400 mt-1">
                                                <%= new Date(message.timestamp).toLocaleString() %>
                                            </p>
                                        </div>
                                    <% }) %>
                                </div>

                                <!-- New Message Input (if applicable) -->
                                <div class="new-message mt-6 flex items-center">
                                    <div class="relative">
                                        <label for="fileInput" class="cursor-pointer">
                                            <i class="fas fa-paperclip text-gray-500 hover:text-blue-500 text-xl"></i>
                                        </label>
                                        <input type="file" id="fileInput" accept="image/*,application/pdf" class="hidden">
                                    </div>
                                    <textarea
                                        class="w-full p-3 ml-2 rounded-md border-2 border-gray-300 dark:border-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-900 dark:text-white"
                                        placeholder="Type your response here..." id="newMessage"></textarea>
                                    <button id="sendMessageButton"
                                        class="bg-[#3A4A8A] text-white px-6 py-2 rounded-md ml-4 shadow-md hover:bg-[#2E376F] transition duration-200">Send</button>
                                </div>

                            </div>


                        </div>
                    </div>
                </main>

    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flowbite@2.5.1/dist/flowbite.min.js"></script>
    <script src="js/flowbite.js"></script>
    <script src="js/dashboard.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        //every time the page is loaded, scroll to the bottom of the chat box
    $(document).ready(function () {
        $('.messages').scrollTop($('.messages')[0].scrollHeight);
    });
    </script>

    <script>
        $(document).ready(function () {
            $('#fileInput').on('change', function () {
                const file = this.files[0];

                if (!file) return; // No file selected

                // Check file type (allow images and PDFs only)
                const allowedTypes = ['image/', 'application/pdf'];
                if (!allowedTypes.some(type => file.type.startsWith(type))) {
                    Swal.fire({
                        title: 'Invalid File',
                        text: 'Please upload a valid image or PDF file.',
                        icon: 'error',
                        confirmButtonColor: '#3A4A8A'
                    });
                    this.value = ''; // Reset the input field
                    return;
                }

                const fileName = file.name;
                Swal.fire({
                    title: 'Are you sure?',
                    text: `Are you sure you want to upload the file: ${fileName}?`,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#3A4A8A',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Yes, upload it!',
                    cancelButtonText: 'No, cancel!'
                }).then((result) => {
                    if (result.isConfirmed) {
                        uploadFile(file);
                    } else {
                        this.value = ''; // Reset file input if the user cancels
                    }
                });
            });

            function uploadFile(file) {
                const ticketNo = "<%= ticket.ticketNo %>"; // Get ticket number dynamically

                const formData = new FormData();
                formData.append('file', file);

                $.ajax({
                    url: `/ticket/${ticketNo}/file-upload`,
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function (data) {
                        if (data.status === 'ok') {
                            Swal.fire({
                                title: 'Success',
                                text: 'File uploaded successfully.',
                                icon: 'success',
                                confirmButtonColor: '#3A4A8A'
                            }).then(() => {
                                location.reload(); // Reload the page to show the uploaded file
                            });
                        } else {
                            Swal.fire({
                                title: 'Error',
                                text: 'Failed to upload file. Please try again.',
                                icon: 'error',
                                confirmButtonColor: '#3A4A8A'
                            });
                        }
                    },
                    error: function (error) {
                        console.error('Error:', error);
                        Swal.fire({
                            title: 'Error',
                            text: 'Failed to upload file. Please try again.',
                            icon: 'error',
                            confirmButtonColor: '#3A4A8A'
                        });
                    }
                });
            }

            $('#sendMessageButton').on('click', function () {
                const message = $('#newMessage').val();
                if (!message) return Swal.fire({
                    title: 'Error',
                    text: 'Message cannot be empty',
                    icon: 'error',
                    confirmButtonColor: '#3A4A8A'
                });

                const sender = 'customer';
                const ticketNo = "<%= ticket.ticketNo %>"; // Get ticketNo dynamically

                $.ajax({
                    url: `/ticket/${ticketNo}/message`,
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ sender, message }),
                    success: function (data) {
                        if (data.status === 'ok') {
                            location.reload(); // Reload to display new message
                        }
                    },
                    error: function (error) {
                        console.error('Error:', error);
                        Swal.fire({
                            title: 'Error',
                            text: 'Failed to send message. Please try again.',
                            icon: 'error',
                            confirmButtonColor: '#3A4A8A'
                        });
                    }
                });
            });
        });
    </script>

</body>

</html>