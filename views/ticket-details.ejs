<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Learning Box - MyOnlinePrep</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
</head>
<link href="https://cdn.jsdelivr.net/npm/flowbite@2.5.1/dist/flowbite.min.css" rel="stylesheet" />
<script src="https://cdn.tailwindcss.com"></script>

</head>

<body>
  <div id="loader">
    <span class="loader"></span>
  </div>

  <div class="antialiased bg-gray-50 dark:bg-gray-900">

    <!-- Navbar -->
    <%- include('components/navbar') %>
    <!-- Sidebar -->
    <%- include('components/sidebar') %>

    <main class="main p-4 md:ml-64 h-screen min-h-screen pt-20 bg-gray-50 dark:bg-gray-900">
        <div class="ticket-details bg-white dark:bg-gray-800 rounded-lg shadow-md p-6">
            <h1 class="text-4xl font-bold text-black dark:text-white">Ticket Details</h1>
            
            <div class="ticket-chat flex flex-col md:flex-row mt-6 space-y-4 md:space-y-0">
                <!-- Ticket Information (Left Side) -->
                <div class="ticket-info w-full md:w-1/3 pr-6 border-b md:border-r border-gray-300 dark:border-gray-700 md:border-b-0">
                    <h2 class="text-2xl font-semibold text-black dark:text-white mb-4">Ticket Information</h2>
                    <div class="ticket-info-list text-sm space-y-2">
                        <p><strong>Ticket Number:</strong> <%= ticket.ticketNo %></p>
                        <p><strong>Full Name:</strong> <%= ticket.fullName %></p>
                        <p><strong>Email:</strong> <%= ticket.email %></p>
                        <p><strong>Phone Number:</strong> <%= ticket.phoneNumber %></p>
                        <p><strong>Address:</strong> <%= ticket.address %></p>
                        <p><strong>Service Type:</strong> <%= ticket.serviceType %></p>
                        <p><strong>Sub-Service:</strong> <%= ticket.subService %></p>
                        <p><strong>Status:</strong> <%= ticket.status %></p>
                        <p><strong>Created At:</strong> <%= ticket.createdAt.toLocaleString() %></p>
                    </div>
                </div>
    
                <!-- Chat Box (Right Side) -->
                <div class="chat-box w-full md:w-2/3 pl-6">
                    <h2 class="text-2xl font-semibold text-black dark:text-white mb-4">Customer Chat</h2>
                
                    <!-- Chat Messages -->
                    <div class="messages space-y-4">
                        <% ticket.conversation.forEach(function(message) { %>
                            <div class="message <%= message.sender === 'customer' ? 'bg-blue-500 text-white' : 'bg-gray-300' %> p-4 rounded-lg max-w-md <%= message.sender === 'customer' ? 'ml-auto' : '' %>">
                                <p><strong><%= message.sender === 'customer' ? ticket.fullName : 'Agent' %>:</strong> <%= message.message %></p>
                                <p class="text-xs text-white-400 mt-1"><%= new Date(message.timestamp).toLocaleString() %></p>
                            </div>
                        <% }) %>
                    </div>
                
                    <!-- New Message Input (if applicable) -->
                    <div class="new-message mt-6">
                        <textarea class="w-full p-3 rounded-md border-2 border-gray-300 dark:border-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-900 dark:text-white" placeholder="Type your response here..." id="newMessage"></textarea>
                        <button class="bg-[#3A4A8A] text-white px-6 py-2 rounded-md mt-4 shadow-md hover:bg-[#2E376F] transition duration-200" onclick="sendMessage()">Send Response</button>
                    </div>
                </div>
                
            </div>
    
            <div class="mt-6">
                <a href="/dashboard" class="bg-[#3A4A8A] text-white px-6 py-2 rounded-md shadow-md hover:bg-[#2E376F] transition duration-200">
                    Back to Dashboard
                </a>
            </div>
        </div>
    </main>

</div>



  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flowbite@2.5.1/dist/flowbite.min.js"></script>
  <script src="js/flowbite.js"></script>
  <script src="js/dashboard.js"></script>

  <script>
    function sendMessage() {
    const message = document.getElementById('newMessage').value;
    if (!message) return alert('Message cannot be empty');

    const sender = 'customer';
    const ticketNo = "<%= ticket.ticketNo %>"; // Get ticketNo dynamically

    fetch(`/ticket/${ticketNo}/message`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ sender, message })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'ok') {
            location.reload(); // Reload to display new message
        }
    })
    .catch(error => console.error('Error:', error));
}

  </script>
</body>

</html>