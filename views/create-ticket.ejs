<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Create Ticket</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
</head>
<link href="https://cdn.jsdelivr.net/npm/flowbite@2.5.1/dist/flowbite.min.css" rel="stylesheet" />
<script src="https://cdn.tailwindcss.com"></script>

</head>

<body>
  <div id="loader">
    <span class="loader"></span>
  </div>

  <div class="antialiased bg-gray-50 dark:bg-gray-900">

    <!-- Navbar -->
    <%- include('components/navbar') %>
    <!-- Sidebar -->
    <%- include('components/sidebar') %>

    <main class="main p-4 md:ml-64 h-screen min-h-screen pt-20 bg-gray-50 dark:bg-gray-900">
        <!-- Header Section -->
        <div class="message flex flex-col md:flex-row justify-between items-center mb-6">
            <div>
                <h1 class="ticketNumber text-4xl font-bold text-black dark:text-white">
                    Create New Ticket
                </h1>
                <p id="message" class="text-lg text-gray-600 dark:text-gray-300">Fill out the form below to create a new support ticket.</p>
            </div>
        </div>
    
        <!-- Main Create Ticket Form Section -->
        <div class="form bg-white dark:bg-gray-800 rounded-lg shadow-md p-6">
            <h2 class="text-xl font-semibold text-gray-800 dark:text-gray-200 mb-4">Ticket Details</h2>
            <form>
                <div class="space-y-4">
                    <!-- Full Name (Disabled) -->
                    <div class="flex flex-col">
                        <label for="fullName" class="text-gray-600 dark:text-gray-400 mb-2">Full Name</label>
                        <input
                            type="text"
                            id="fullName"
                            name="fullName"
                            value="<%= user.fullName %>"
                            class="p-2 bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-[#3A4A8A]"
                            disabled
                        />
                    </div>
    
                    <!-- Email (Disabled) -->
                    <div class="flex flex-col">
                        <label for="email" class="text-gray-600 dark:text-gray-400 mb-2">Email</label>
                        <input
                            type="email"
                            id="email"
                            name="email"
                            value="<%= user.email %>"
                            class="p-2 bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-[#3A4A8A]"
                            disabled
                        />
                    </div>
    
                    <!-- Phone Number (Editable) -->
                    <div class="flex flex-col">
                        <label for="phoneNumber" class="text-gray-600 dark:text-gray-400 mb-2">Phone Number</label>
                        <input
                            type="tel"
                            id="phoneNumber"
                            name="phoneNumber"
                            class="p-2 bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-[#3A4A8A]"
                            placeholder="Enter your phone number"
                            required
                        />
                    </div>
    
                    <!-- Occupation Field -->
                    <div class="flex flex-col">
                        <label for="occupation" class="text-gray-600 dark:text-gray-400 mb-2">Occupation</label>
                        <input
                            type="text"
                            id="occupation"
                            name="occupation"
                            class="p-2 bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-[#3A4A8A]"
                            placeholder="Enter your occupation"
                            required
                        />
                    </div>

                    <!-- Address Field -->
                    <div class="flex flex-col">
                        <label for="address" class="text-gray-600 dark:text-gray-400 mb-2">Address</label>
                        <input
                            type="text"
                            id="address"
                            name="address"
                            class="p-2 bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-[#3A4A8A]"
                            placeholder="Enter your address"
                            required
                        />
                    </div>
    
                    <!-- Marital Status Type Selection -->
                    <div class="flex flex-col">
                        <label for="maritalStatus" class="text-gray-600 dark:text-gray-400 mb-2">Select Marital Status</label>
                        <select
                            id="maritalStatus"
                            name="maritalStatus"
                            class="p-2 bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-[#3A4A8A]"
                            required
                        >
                            <option value="">Select Status</option>
                            <option value="Single">Single</option>
                            <option value="Married">Married</option>
                        </select>
                    </div>

                    <!-- Service Type Selection -->
                    <div class="flex flex-col">
                        <label for="serviceType" class="text-gray-600 dark:text-gray-400 mb-2">Select Service</label>
                        <select
                            id="serviceType"
                            name="serviceType"
                            class="p-2 bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-[#3A4A8A]"
                            required
                        >
                            <option value="">Select Service</option>
                            <option value="Accounting">Accounting Services</option>
                            <option value="Legal">Legal Services</option>
                            <option value="Immigration">Personal Immigration</option>
                            <option value="Personal_Injury">Personal Injury</option>
                            <option value="Accidental_Claim">Accidental Claim Services</option>
                            <option value="Family">Family Services</option>
                            <option value="Motoring_Law">Motoring Law</option>
                            <option value="Other">Other Services</option>
                        </select>
                    </div>
    
                    <!-- Sub-Service Dropdown (Hidden initially) -->
                    <div id="subServiceContainer" class="flex flex-col hidden">
                        <label for="subService" class="text-gray-600 dark:text-gray-400 mb-2">Select Sub-Service</label>
                        <select
                            id="subService"
                            name="subService"
                            class="p-2 bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-[#3A4A8A]"
                        >
                            <!-- Sub-services will be dynamically loaded here -->
                        </select>
                    </div>
    
                    <!-- Issue Description -->
                    <div class="flex flex-col">
                        <label for="description" class="text-gray-600 dark:text-gray-400 mb-2">Issue Description</label>
                        <textarea
                            id="description"
                            name="description"
                            rows="4"
                            class="p-2 bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-[#3A4A8A]"
                            placeholder="Describe your issue in detail"
                            required
                        ></textarea>
                    </div>

                    <!-- File -->
                    <div class="flex flex-col">
                        <label for="file" class="text-gray-600 dark:text-gray-400 mb-2">Attach File (Optional)</label>
                        <input
                            type="file"
                            id="file"
                            name="file"
                            accept="image/*,application/pdf"
                            class="p-2 bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-[#3A4A8A]"
                        />
    
                    <!-- Submit Button -->
                    <div class="mt-4">
                        <button
                            type="submit"
                            class="bg-[#3A4A8A] text-white px-6 py-2 rounded-md shadow-md hover:bg-[#2E376F] transition duration-200"
                        >
                            Create Ticket
                        </button>
                    </div>
                </div>
            </form>
        </div>
    
        <!-- JavaScript to handle service and sub-service display -->
        <script>
            const serviceSelect = document.getElementById('serviceType');
            const subServiceContainer = document.getElementById('subServiceContainer');
            const subServiceSelect = document.getElementById('subService');
    
            const subServices = {
                Accounting: [
                    "Cloud Accounting",
                    "Account Management",
                    "CIS Tax Returns",
                    "Self Assessment",
                    "Payroll Services",
                    "VAT Returns Service"
                ],
                Legal: [
                    "Data Claims",
                    "Debt & Insolvency",
                    "Education Law Services"
                ],
                Immigration: [
                    "In-Country Applications",
                    "Out of Country Applications",
                    "Business Immigration",
                    "Immigration Appeals"
                ],
                Personal_Injury: [
                    "Abuse Claims",
                    "Cycling Accident Claims",
                    "Spinal Cord Injury Claims",
                    "Pedestrian Accident Claims",
                    "Paralysis Claims",
                    "Major Trauma Claims",
                    "Brain Injury Compensation Claims",
                    "Burns and Scalding Claims",
                    "Catastrophic Injury Claims",
                    "Plumbing Claims",
                    "Disrepair by a Landlord Claims",
                    "Loss of Sight Claims",
                    "Road Traffic Accidents Solicitors",
                    "Post Traumatic Stress Disorder Claims"
                ],
                Accidental_Claim: [
                    "Car Accident Claims",
                    "Cycling Accident Claims",
                    "Passenger Accident Claims",
                    "Pedestrian Accident Claims",
                    "Motorbike Accident Claims"
                ],
                Family: [
                    "Divorce Solicitors",
                    "High Net Worth Divorce",
                    "Court of Protection and Deprivation of Liberty in Family Law",
                    "Financial and Property",
                    "Civil Partnerships and Dissolution",
                    "Prenuptial and Postnuptial Agreements",
                    "Family Mediation",
                    "International Family Lawyers",
                    "Islamic Law"
                ],
                Motoring_Law: [
                    "Dangerous Driving",
                    "Drink or Drug Driving Allegation After Being Taken to Hospital",
                    "Drink Driving Allegation with a Sample of Blood or Urine",
                    "Drink Driving Allegation with a Breath Test",
                    "Causing Death by Dangerous Driving",
                    "Indictable Road Traffic Offences",
                    "HGV Offences",
                    "Drug Driving Allegation",
                    "Failing to Provide a Specimen",
                    "Offences of Being In Charge",
                    "Dangerous Driving Allegation",
                    "Motoring Offences"
                ],
                Other: [
                    "Welfare Benefits",
                    "Universal Credit",
                    "Tribunal Hearings",
                    "Housing Benefits",
                    "Housing/Social Housing Issues",
                    "Housing Disrepairs",
                    "Translations",
                    "Tenancy Agreement",
                    "School Applications",
                    "PIP/ESA Applications",
                    "Pay Roll",
                    "Passport Applications",
                    "Citizenship Applications",
                    "Immigration & Interpreter",
                    "Child Tax Credit/Working Tax/Child Benefit",
                    "Nino Applications",
                    "HM Land Registry",
                    "GP Hospital Services",
                    "Motoring Offences",
                    "Debt",
                    "Accident Injury Claims",
                    "24hr Police Station Representation",
                    "Company House Registrations",
                    "Statutory Declarations",
                    "Insurance Disputes",
                    "Employment Law"
                ]
            };
    
            serviceSelect.addEventListener('change', function() {
                const selectedService = serviceSelect.value;
                subServiceSelect.innerHTML = ''; // Clear previous options
                if (selectedService) {
                    subServiceContainer.classList.remove('hidden');
                    const options = subServices[selectedService];
                    options.forEach(subService => {
                        const option = document.createElement('option');
                        option.value = subService;
                        option.textContent = subService;
                        subServiceSelect.appendChild(option);
                    });
                } else {
                    subServiceContainer.classList.add('hidden');
                }
            });
        </script>

</main>
    

</div>



  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flowbite@2.5.1/dist/flowbite.min.js"></script>
  <script src="js/flowbite.js"></script>
  <script src="js/dashboard.js"></script>

  <!-- Include iziToast library (in the head section of your HTML file) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/izitoast/dist/css/iziToast.min.css">
<script src="https://cdn.jsdelivr.net/npm/izitoast/dist/js/iziToast.min.js"></script>

<script>
$(document).ready(function() {
    // Handle form submission
    $('form').submit(function(event) {
        event.preventDefault(); // Prevent form from submitting normally

        // Collect form data
        const formData = new FormData();
        formData.append('fullName', $('#fullName').val());
        formData.append('email', $('#email').val());
        formData.append('phoneNumber', $('#phoneNumber').val());
        formData.append('address', $('#address').val());
        formData.append('occupation', $('#occupation').val());
        formData.append('maritalStatus', $('#maritalStatus').val());
        formData.append('serviceType', $('#serviceType').val());
        formData.append('subService', $('#subService').val());
        formData.append('description', $('#description').val());

        // Check if a file is selected
        const fileInput = $('#file')[0];
        if (fileInput.files.length > 0) {
            const file = fileInput.files[0];
            formData.append('file', file);
        }

        // Send AJAX request to server to create the ticket
        $.ajax({
            url: '/create-ticket', 
            method: 'POST',
            data: formData,
            processData: false,  // Important: Don't process the data
            contentType: false,  // Important: Don't set content type
            success: function(response) {
                if (response.status === 'ok') {
                    // Show success message using iziToast
                    iziToast.success({
                        title: 'Success',
                        message: `Your ticket number is: ${response.ticketNo}`,
                        position: 'topRight',
                        timeout: 5000
                    });

                    // Hide the form and show the ticket number message
                    $('.form').hide();
                    $('.ticketNumber').text('Ticket Number: ' + response.ticketNo);
                    $('#message').text('Our agent will contact you as soon as possible.');

                    // Add a button to go back to the dashboard
                    const dashboardButton = $('<button>') 
                        .text('Go to Dashboard')
                        .addClass('bg-[#3A4A8A] text-white px-6 py-2 rounded-md shadow-md hover:bg-[#2E376F] transition duration-200')
                        .on('click', function() {
                            window.location.href = '/dashboard'; // Redirect to dashboard
                        });

                    $('.message').append(dashboardButton); // Append the button to the page
                }
            },
            error: function(xhr, status, error) {
                // Show error message using iziToast
                iziToast.error({
                    title: 'Error',
                    message: 'Something went wrong. Please try again later.',
                    position: 'topRight',
                    timeout: 5000
                });
            }
        });
    });
});

</script>

</body>

</html>
